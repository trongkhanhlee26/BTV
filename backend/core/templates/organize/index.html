{% load static %}
<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>Tổ chức cuộc thi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --txt: #e5e7eb;
            --brand: #f59e0b;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--txt);
            font-family: system-ui, Segoe UI, Roboto, Inter, Arial
        }

        .container {
            max-width: 1000px;
            margin: 24px auto;
            padding: 0 16px
        }

        h1 {
            font-size: 24px;
            margin: 0 0 16px
        }

        .grid {
            display: grid;
            gap: 16px
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #1f2937
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .row input,
        .row select {
            background: #0b1220;
            color: var(--txt);
            border: 1px solid #243045;
            border-radius: 8px;
            padding: 8px 10px;
            outline: none
        }

        .row label {
            font-size: 14px;
            color: var(--muted)
        }

        .btn {
            background: var(--brand);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: #111827;
            font-weight: 600;
            cursor: pointer
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .ct {
            border-left: 4px solid var(--brand);
            padding-left: 12px;
            margin: 8px 0
        }

        .vt {
            margin: 8px 0 8px 12px;
            border-left: 3px solid #334155;
            padding-left: 12px
        }

        .bt {
            margin: 6px 0 6px 24px;
            border-left: 2px dashed #334155;
            padding-left: 12px
        }

        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            background: #0b1220;
            border: 1px solid #1f2937;
            padding: 2px 6px;
            border-radius: 6px
        }

        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px
        }

        .on {
            background: #065f46
        }

        .off {
            background: #4b5563
        }

        .sec-title {
            font-size: 16px;
            margin: 0 0 8px;
            font-weight: 700
        }

        .hr {
            height: 1px;
            background: #1f2937;
            margin: 12px 0
        }

        .msg {
            margin: 0 0 8px
        }
        /* Toggle switch */
        .switch {
        position: relative; display: inline-block; width: 46px; height: 26px; vertical-align: middle;
        }
        .switch input { display: none; }
        .slider {
        position: absolute; cursor: pointer; inset: 0; background: #374151; border-radius: 999px;
        transition: background .2s ease;
        }
        .slider:before {
        content: ""; position: absolute; height: 20px; width: 20px; left: 3px; top: 3px;
        background: white; border-radius: 50%; transition: transform .2s ease;
        }
        .switch input:checked + .slider { background: #10b981; }
        .switch input:checked + .slider:before { transform: translateX(20px); }

    </style>
</head>

<body>
    <div class="container">
        <h1>Tổ chức cuộc thi</h1>
        <div style="margin:6px 0">
            <a href="/organize/competitions/" style="color:#93c5fd;text-decoration:none">→ Quản lý Cuộc thi
                (thêm/sửa/xoá)</a>
        </div>

        {% if messages %}
        <div style="margin:10px 0">
            {% for m in messages %}
            <div style="margin:6px 0; padding:8px 10px; border-radius:8px; background:#064e3b; color:#d1fae5;">
                {{ m }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="grid">
            <!-- Tạo Cuộc thi -->
            <div class="card">
                <div class="sec-title">Tạo cuộc thi</div>
                <form method="post" class="row" style="align-items:center;gap:12px">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_ct">
                    <label>Tên cuộc thi</label>
                    <input type="text" name="tenCuocThi" placeholder="VD: Cuộc thi tay nghề 2025" required>
                    <label>Trạng thái</label>
                    <label style="display:flex;align-items:center;gap:6px">
                        <input type="checkbox" name="trangThai"> Bật
                    </label>
                    <button class="btn" type="submit">Tạo</button>
                </form>
            </div>

            <!-- Danh sách Cuộc thi -->
            <div class="card">
                <div class="sec-title">Danh sách cuộc thi</div>
                <div class="muted">Nhấn “Thêm vòng thi” / “Thêm bài thi” để bổ sung nhanh.</div>
                <div class="hr"></div>

                {% for ct in cuoc_this %}
                <div class="ct">
                    <div>
                        <span class="code">{{ ct.ma }}</span>
                        &nbsp;{{ ct.tenCuocThi }}
                        &nbsp;<span class="status {{ ct.trangThai|yesno:'on,off' }}">
                        {{ ct.trangThai|yesno:"Đang bật,Đang tắt" }}
                        </span>

                        <!-- Nút trượt bật/tắt ngay bên cạnh -->
                        <form method="post" style="display:inline-block; margin-left:8px">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle_ct">
                        <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                        <label class="switch" title="Bật/tắt cuộc thi">
                            <input type="checkbox" name="trangThai" {% if ct.trangThai %}checked{% endif %} onchange="this.form.submit()">
                            <span class="slider"></span>
                        </label>
                        </form>


                    </div>

                    <!-- Form thêm Vòng thi cho Cuộc thi này -->
                    <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_vt">
                        <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                        <label>Thêm vòng thi</label>
                        <input type="text" name="tenVongThi" placeholder="VD: Vòng loại" required>
                        <button class="btn" type="submit">Thêm vòng</button>
                    </form>

                    {% for vt in ct.vong_thi.all %}
                    <div class="vt">
                        <div><span class="code">{{ vt.ma }}</span> {{ vt.tenVongThi }}</div>

                        <!-- Form thêm Bài thi cho Vòng này -->
                        <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create_bt">
                            <input type="hidden" name="vongThi_id" value="{{ vt.id }}">
                            <label>Thêm bài thi</label>
                            <input type="text" name="tenBaiThi" placeholder="VD: Lý thuyết" required>
                            <label>Phương thức chấm</label>
                            <select name="phuongThucCham">
                                <option value="TIME">Chấm theo thời gian</option>
                                <option value="TEMPLATE">Chấm theo mẫu</option>
                                <option value="POINTS" selected>Chấm theo thang điểm</option>
                            </select>
                            <label class="js-max-label">Điểm tối đa</label>
                            <input type="number" name="cachChamDiem" min="1" step="1" placeholder="VD: 10"
                                class="js-max-input" style="width:100px">
                            <button class="btn" type="submit">Thêm bài</button>
                        </form>

                        {% for bt in vt.bai_thi.all %}
                        <div class="bt">
                            <div>
                                <span class="code">{{ bt.ma }}</span>
                                {{ bt.tenBaiThi }}
                                {% if bt.phuongThucCham == "POINTS" %}
                                — Thang điểm (Max: {{ bt.cachChamDiem }})
                                {% elif bt.phuongThucCham == "TIME" %}
                                — Theo thời gian
                                <button class="btn" data-open-time-modal data-btid="{{ bt.id }}"
                                    data-rules='[{% for r in bt.time_rules.all %}{"start":{{ r.start_seconds }},"end":{{ r.end_seconds }},"score":{{ r.score }}}{% if not forloop.last %},{% endif %}{% endfor %}]'>
                                    Cấu hình thang thời gian
                                </button>

                                {% if bt.time_rules.all|length %}
                                <div class="muted" style="margin-top:4px;font-size:12px">
                                    {% for r in bt.time_rules.all %}
                                    {% if not forloop.first %}; {% endif %}{{ r.start_seconds }}s–{{ r.end_seconds }}s:
                                    +{{ r.score }}đ
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% else %}
                                — Theo mẫu
                                <button class="btn" type="button" data-open-tpl-modal data-btid="{{ bt.id }}">
                                    Cấu hình mẫu chấm
                                </button>

                                {% if bt.template_sections.all|length %}
                                <div class="muted" style="margin-top:4px;font-size:12px">
                                    {{ bt.template_sections.all|length }} mục lớn —
                                    {% for s in bt.template_sections.all %}
                                    {{ s.items.all|length }}{% if not forloop.last %}+{% endif %}
                                    {% endfor %} mục nhỏ (tổng từng phần).
                                </div>
                                {% endif %}

                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="bt muted">Chưa có bài thi.</div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <div class="vt muted">Chưa có vòng thi.</div>
                    {% endfor %}
                </div>
                <div class="hr"></div>
                {% empty %}
                <div class="muted">Chưa có cuộc thi nào. Hãy tạo cuộc thi đầu tiên ở trên.</div>
                {% endfor %}
            </div>
        </div>

        <p class="muted" style="margin-top:10px">
            Tip: Mã (CTxxx/VTxxx/BTxxx) sẽ tự sinh khi tạo mới.
        </p>
    </div>

    <!-- MODAL cấu hình thời gian -->
    <div id="time-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:640px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">Cấu hình thang thời gian</div>
                <button id="tm-close" class="btn" type="button">Đóng</button>
            </div>
            <form id="tm-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="config_time_rules">
                <input type="hidden" name="baiThi_id" id="tm-btid">
                <input type="hidden" name="time_rules_json" id="tm-json">
                <div class="row" style="margin-bottom:8px">
                    <button class="btn" type="button" id="tm-add">+ Thêm dòng</button>
                </div>
                <div id="tm-rows" class="grid" style="gap:8px"></div>
                <div class="row" style="margin-top:12px; justify-content:flex-end">
                    <button class="btn" type="submit">Lưu cấu hình</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL cấu hình mẫu chấm -->
    <div id="tpl-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:560px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">Import mẫu chấm (Excel)</div>
                <button id="tpl-close" class="btn" type="button">Đóng</button>
            </div>

            <form id="tpl-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="config_template_upload">
                <input type="hidden" name="baiThi_id" id="tpl-btid">
                <div class="row" style="gap:10px; align-items:center">
                    <label>Tệp .xlsx</label>
                    <input type="file" name="template_file" id="tpl-file" accept=".xlsx" required
                        style="background:#0b1220;color:#e5e7eb;border:1px solid #243045;border-radius:8px;padding:8px 10px">
                    <button class="btn" type="submit">Tải lên & Lưu</button>
                </div>
                <div class="muted" style="margin-top:8px;font-size:12px">
                    Yêu cầu cột: <em>Section/Mục lớn</em>, <em>Item/Mục nhỏ</em>, <em>Điểm/Max</em> (có thể thêm Ghi
                    chú).
                </div>
            </form>
        </div>
    </div>

    <script src="{% static 'core/organize.js' %}?v={% now 'U' %}"></script>
</body>

</html>