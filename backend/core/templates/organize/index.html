{% extends "base.html" %}
{% load static %}
{% block title %}Tạo cuộc thi{% endblock %}
<!doctype html>
<html lang="vi">

{% block head_extra %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
  
            --txt: #e5e7eb;
            --brand: #f59e0b;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--txt);
            font-family: system-ui, Segoe UI, Roboto, Inter, Arial
        }

        .container {
            max-width: 1000px;
            margin: 24px auto;
            padding: 0 16px
        }

        h1 {
            font-size: 24px;
            margin: 0 0 16px
        }

        .grid {
            display: grid;
            gap: 16px
        }

        /* Liquid glass card */
        .card {
        position: relative;
        border-radius: 16px;
        padding: 16px;
        /* lớp kính trong suốt mờ */
        background: linear-gradient( to bottom right, rgba(255,255,255,0.1), rgba(255,255,255,0.06) );
        border: 1px solid rgba(255,255,255,0.14);
        box-shadow:
            0 10px 30px rgba(0,0,0,0.35),
            inset 0 1px 0 rgba(255,255,255,0.08);

        /* hiệu ứng blur kính */
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        }

        /* viền highlight mềm ở mép trên để “ướt” hơn */
        .card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background:
            radial-gradient(120% 120% at -10% -20%, rgba(255,255,255,0.20), transparent 45%),
            radial-gradient(110% 110% at 120% -10%, rgba(255,255,255,0.12), transparent 45%);
        /* không che nội dung, chỉ tạo ánh sáng nhẹ */
        mix-blend-mode: screen;
        opacity: .7;
        }


        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .row input,
        .row select {
            background: #0b1220;
            color: var(--txt);
            border: 1px solid #243045;
            border-radius: 8px;
            padding: 8px 10px;
            outline: none
        }

        .row label {
            font-size: 14px;
            color: var(--muted)
        }

    .btn {
      background: #f4f1ecc6;
      color: #223382;
      border: none;
      border-radius: 14px;
      padding: 5px 10px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      font-size: 13px;

      -webkit-backdrop-filter: blur(8px) saturate(130%);
      backdrop-filter: blur(8px) saturate(130%);
      box-shadow:
        0 12px 24px rgba(173, 188, 244, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }
/* Nút icon: cao như .btn và canh giữa theo trục dọc */
.btn-icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 7px 14px;   /* giống .btn để cao ngang nhau */
  line-height: 1;      /* tránh kéo dãn chiều cao */
  vertical-align: middle;
}



    .btn::after {
      /* highlight gợn kính */
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(120% 80% at 30% -10%,
        rgba(255,255,255,0.45), rgba(255,255,255,0.0) 45%);
      pointer-events: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 16px 30px rgba(212, 192, 249, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    .btn:active { transform: translateY(0); }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .ct {
            border-left: 4px solid var(--brand);
            padding-left: 12px;
            margin: 8px 0
        }

        .vt {
            margin: 8px 0 8px 12px;
            border-left: 3px solid #334155;
            padding-left: 12px
        }

        .bt {
            margin: 6px 0 6px 24px;
            border-left: 2px dashed #334155;
            padding-left: 12px
        }

        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            padding: 2px 6px;
            border-radius: 6px
        }

        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px
        }

        .on {
            background: #065f46
        }

        .off {
            background: #4b5563
        }

        .sec-title {
            font-size: 16px;
            margin: 0 0 8px;
            font-weight: 700
        }

        .hr {
            height: 1px;
            background: #1f2937;
            margin: 12px 0
        }

        .msg {
            margin: 0 0 8px
        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
            vertical-align: middle;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #374151;
            border-radius: 999px;
            transition: background .2s ease;
        }

        .slider:before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: transform .2s ease;
        }

        .switch input:checked+.slider {
            background: #10b981;
        }

        .switch input:checked+.slider:before {
            transform: translateX(20px);
        }
        /* ------- Zebra table for modal config view ------- */
#tplv-content table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 14px;
  overflow: hidden;          /* clip nền các hàng theo radius */
  border: 1px solid #334155; /* viền nhẹ */
}

#tplv-content thead th {   
  background: #0b1220;        /* đầu bảng đậm hơn */
  color: #e5e7eb;
  border-bottom: 1px solid #334155;
  padding: 8px 10px;
  position: sticky; top: 0; z-index: 1; /* cố định header khi nội dung dài */
  width: 20px;

}

#tplv-content tbody tr:nth-child(odd) {
  background: rgba(255,255,255,0.12);   /* hàng 1,3,5... đậm hơn */
}

#tplv-content tbody tr:nth-child(even) {
  background: rgba(255,255,255,0.06);   /* hàng 2,4,6... nhạt hơn */
}

#tplv-content tbody tr:hover {
  background: rgba(255,255,255,0.18);   /* hover nổi hơn */
}

#tplv-content td {
  padding: 8px 10px;
  border-bottom: 1px solid #1f2937;
}

    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div style="margin:6px 0; margin-top: 50px;">
            <a href="/organize/competitions/" style="color:#edf0f3;text-decoration:none">← Trang Danh sách cuộc thi</a>
        </div>

        {% if messages %}
        <div style="margin:10px 0">
            {% for m in messages %}
            <div style="margin:6px 0; padding:8px 10px; border-radius:8px; background:#064e3b; color:#d1fae5;">
                {{ m }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="grid">

            <!-- Danh sách Cuộc thi -->
            <div class="card">
                <div class="sec-title">Danh sách cuộc thi</div>
                <div class="muted">Nhấn “Thêm vòng thi” / “Thêm bài thi” để bổ sung nhanh.</div>
                <div class="hr"></div>

                {% for ct in cuoc_this %}
                <div class="ct">
                    <div>
                        <span class="code">{{ ct.ma }}</span>
                        &nbsp;{{ ct.tenCuocThi }}
                        &nbsp;<span class="status {{ ct.trangThai|yesno:'on,off' }}">
                            {{ ct.trangThai|yesno:"Đang bật,Đang tắt" }}
                        </span>

                        <!-- Nút trượt bật/tắt ngay bên cạnh -->
                        <form method="post" style="display:inline-block; margin-left:8px">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_ct">
                            <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                            <label class="switch" title="Bật/tắt cuộc thi">
                                <input type="checkbox" name="trangThai" {% if ct.trangThai %}checked{% endif %}
                                    onchange="this.form.submit()">
                                <span class="slider"></span>
                            </label>
                        </form>


                    </div>

                    <!-- Form thêm Vòng thi cho Cuộc thi này -->
                    <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_vt">
                        <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                        <label>Thêm vòng thi</label>
                        <input type="text" name="tenVongThi" placeholder="VD: Vòng loại" required>
                        <button class="btn" type="submit">Thêm vòng</button>
                    </form>

                    {% for vt in ct.vong_thi.all %}
                    <div class="vt">
                        <div><span class="code">{{ vt.ma }}</span> {{ vt.tenVongThi }}</div>

                        <!-- Form thêm Bài thi cho Vòng này -->
                        <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create_bt">
                            <input type="hidden" name="vongThi_id" value="{{ vt.id }}">
                            <label>Thêm bài thi</label>
                            <input type="text" name="tenBaiThi" placeholder="VD: Lý thuyết" required>
                            <label>Phương thức chấm</label>
                            <select name="phuongThucCham">
                                <option value="TIME">Chấm theo thời gian</option>
                                <option value="TEMPLATE">Chấm theo mẫu</option>
                                <option value="POINTS" selected>Chấm theo thang điểm</option>
                            </select>
                            <label class="js-max-label">Điểm tối đa</label>
                            <input type="number" name="cachChamDiem" min="1" step="1" placeholder="VD: 10"
                                class="js-max-input" style="width:100px">
                            <button class="btn" type="submit">Thêm bài</button>
                        </form>

                        {% for bt in vt.bai_thi.all %}
                        <div class="bt">
                            <div>
                                <span class="code">{{ bt.ma }}</span>
                                {{ bt.tenBaiThi }}
                                {% if bt.phuongThucCham == "POINTS" %}
                                — Thang điểm (Max: {{ bt.cachChamDiem }})
                                {% elif bt.phuongThucCham == "TIME" %}
                                — Theo thời gian
                                <button class="btn" data-open-time-modal data-btid="{{ bt.id }}"
                                    data-rules='[{% for r in bt.time_rules.all %}{"start":{{ r.start_seconds }},"end":{{ r.end_seconds }},"score":{{ r.score }}}{% if not forloop.last %},{% endif %}{% endfor %}]'>
                                    Cấu hình thang thời gian
                                </button>

                                {% if bt.time_rules.all|length %}
                                <div class="muted" style="margin-top:4px;font-size:12px">
                                    {% for r in bt.time_rules.all %}
                                    {% if not forloop.first %}; {% endif %}{{ r.start_seconds }}s–{{ r.end_seconds }}s:
                                    +{{ r.score }}đ
                                    {% endfor %}
                                </div>
                                {% endif %}

                               {% else %}
                                 — Theo mẫu
                                 <button class="btn" type="button" data-open-tpl-modal data-btid="{{ bt.id }}">
                                   Cấu hình mẫu chấm
                                 </button>

                                 {# Nếu đã có file/sections thì hiển thị nút xem cấu hình #}
                                 {% if bt.template_sections.all|length %}
                                    <button class="btn btn-icon" type="button"
                                            data-open-tpl-view
                                            data-target="tplview-{{ bt.id }}"
                                            title="Xem cấu hình đã thêm"
                                            aria-label="Xem cấu hình đã thêm">
                                    <img src="{% static 'pics/more.png' %}"
                                        alt="Xem cấu hình"
                                        width="18" height="18"
                                        style="display:block;pointer-events:none">
                                    </button>

                                   {# Nội dung bảng chi tiết render sẵn (ẩn), khi bấm sẽ copy vào popup #}
                                   <div id="tplview-{{ bt.id }}" style="display:none">
                                     <div style="margin-bottom:8px">
                                       <span class="code">{{ vt.ma }}</span> {{ vt.tenVongThi }}
                                       &nbsp;•&nbsp;
                                       <span class="code">{{ bt.ma }}</span> {{ bt.tenBaiThi }}
                                     </div>

                                     <table class="table" style="width:100%;">
                                       <thead>
                                         <tr>
                                           <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">Mục lớn</th>
                                           <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">Mục nhỏ</th>
                                           <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">Điểm/Max</th>
                                           <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">Ghi chú</th>
                                         </tr>
                                       </thead>
                                        <tbody>
                                        {% for s in bt.template_sections.all %}
                                            {% for i in s.items.all %}
                                            <tr>
                                                <td style="padding:6px 8px">
                                                  {{ s.title }}
                                                </td>

                                                <td style="padding:6px 8px">
                                                {{ i.content }}
                                                </td>

                                                <td style="padding:6px 8px; text-align:center">
                                                {% if i.max_score or i.max_score == 0 %}
                                                    {{ i.max_score }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                                </td>

                                                <td style="padding:6px 8px">
                                                {% if i.ghiChu %}{{ i.ghiChu }}{% elif i.note %}{{ i.note }}{% else %}{% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% empty %}
                                            <tr><td colspan="4" class="muted" style="padding:6px 8px">Chưa có mục nhỏ.</td></tr>
                                        {% endfor %}
                                        </tbody>

                                     </table>
                                   </div>
                                 {% endif %}
                               {% endif %}

                            </div>
                        </div>
                        {% empty %}
                        <div class="bt muted">Chưa có bài thi.</div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <div class="vt muted">Chưa có vòng thi.</div>
                    {% endfor %}
                </div>
                <div class="hr"></div>
                {% empty %}
                <div class="muted">Chưa có cuộc thi nào. Hãy tạo cuộc thi đầu tiên ở trên.</div>
                {% endfor %}
            </div>
        </div>

        <p class="muted" style="margin-top:10px">
            Tip: Mã (CTxxx/VTxxx/BTxxx) sẽ tự sinh khi tạo mới.
        </p>
    </div>

    <!-- MODAL cấu hình thời gian -->
    <div id="time-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:1100px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">Cấu hình thang thời gian</div>
                <button id="tm-close" class="btn" type="button">Đóng</button>
            </div>
            <form id="tm-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="config_time_rules">
                <input type="hidden" name="baiThi_id" id="tm-btid">
                <input type="hidden" name="time_rules_json" id="tm-json">
                <div class="row" style="margin-bottom:8px">
                    <button class="btn" type="button" id="tm-add">Thêm dòng</button>
                </div>
                <div id="tm-rows" class="grid" style="gap:8px"></div>
                <div class="row" style="margin-top:12px; justify-content:flex-end">
                    <button class="btn" type="submit">Lưu cấu hình</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL cấu hình mẫu chấm -->
    <div id="tpl-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:560px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">Import mẫu chấm (Excel)</div>
                <button id="tpl-close" class="btn" type="button">Đóng</button>
            </div>

            <form id="tpl-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="config_template_upload">
                <input type="hidden" name="baiThi_id" id="tpl-btid">
                <div class="row" style="gap:10px; align-items:center">
                    <label>Tệp .xlsx</label>
                    <input type="file" name="template_file" id="tpl-file" accept=".xlsx" required
                        style="background:#0b1220;color:#e5e7eb;border:1px solid #243045;border-radius:8px;padding:8px 10px">
                    <button class="btn" type="submit">Tải lên & Lưu</button>
                </div>
                <div class="muted" style="margin-top:8px;font-size:12px">
                    Yêu cầu cột: <em>Section/Mục lớn</em>, <em>Item/Mục nhỏ</em>, <em>Điểm/Max</em> (có thể thêm Ghi
                    chú).
                </div>
            </form>
        </div>
    </div>
<!-- MODAL xem cấu hình đã thêm -->
<div id="tpl-view-modal"
     style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
  <div class="card" style="width:1200px; max-width:96vw; padding:16px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="sec-title">Cấu hình đã thêm</div>
      <button id="tplv-close" class="btn btn-sm" type="button">Đóng</button>
    </div>
    <div id="tplv-content"></div>
  </div>
</div>

    <script src="{% static 'core/organize.js' %}?v={% now 'U' %}"></script>
{% endblock %}
