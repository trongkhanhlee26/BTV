{% extends "base.html" %}
{% load static %}
{% block title %}Quản Lý Tổng | ExamSite{% endblock %}

{% block head_extra %}
<style>

/* Chỉ áp dụng trong vùng dashboard để không ảnh hưởng navbar */
#dashboard .sidebar{
  width:240px; min-width:240px; border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
  border-right:1px solid rgba(255,255,255,.28);
  backdrop-filter:blur(14px) saturate(112%);
  -webkit-backdrop-filter:blur(14px) saturate(112%);
  box-shadow:0 6px 24px rgba(0,0,0,.10);
}
#dashboard .glass{
  background:rgba(255,255,255,.20);               /* ↓ trắng ít hơn */
  border:1px solid rgba(255,255,255,.32);         /* ↓ viền nhẹ hơn */
  border-radius:16px;
  backdrop-filter:blur(14px) saturate(112%);      /* ↓ blur nhẹ hơn */
  -webkit-backdrop-filter:blur(14px) saturate(112%);
  box-shadow:0 6px 24px rgba(0,0,0,.10);
}


    .dist-bar {
        height: .75rem;
        width: 100%;
        border-radius: 9999px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    .dist-seg {
        height: 100%;
        float: left;
        width: calc(var(--p, 0) * 1%)
    }

    .seg-high {
        background: #22c55e
    }

    .seg-mid {
        background: #f59e0b
    }

    .seg-low {
        background: #ef4444
    }
</style>
{% endblock %}

{% block content %}

<div id="dashboard" class="flex gap-6">
    <!-- Sidebar: chỉ Export -->
    <aside class="sidebar p-4">
        <div class="mt-2 p-3 bg-white/5 rounded-xl">
            <div class="text-sm opacity-80 mb-2">Báo cáo</div>
            <a href="/export{% if contest %}?ct={{ contest.id }}{% endif %}"
                class="w-full inline-flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg">
                <img src="{% static 'icons/download.svg' %}" class="h-4 w-4" alt="">
                <span>Export</span>
            </a>
        </div>
    </aside>

    <!-- Nội dung -->
    <div class="flex-1">
        <div class="mx-auto max-w-7xl px-2 lg:px-4">
            {% if no_contest %}
            <div class="glass p-6 mt-6 text-center">
                <h1 class="text-2xl font-semibold mb-2">Chưa có cuộc thi nào đang diễn ra</h1>
                <p class="opacity-80">Hãy tạo cuộc thi mới tại <a href="/organize"
                        class="underline hover:text-blue-400">Trang Tổ chức</a>.</p>
            </div>
            {% else %}

            <!-- HÀNG TRÊN: A + B -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 mt-6 items-stretch">
                <!-- A -->
                <div id="contestCard"
                    class="xl:col-span-7 glass p-5 flex items-center justify-between hover:bg-white/10 transition">
                    <div>
                        <div class="text-sm opacity-70 mb-1">Cuộc thi đang diễn ra</div>
                        <h2 class="text-2xl font-semibold leading-tight">{{ contest.tenCuocThi }}</h2>
                        <div class="text-sm opacity-75 mt-2">Mã: <span class="font-semibold">{{ contest.ma }}</span>
                        </div>
                    </div>
                    <img src="{% static 'pics/tournament.png' %}" alt="" class="h-14 w-14 opacity-90">
                </div>

                <!-- B -->
                <div class="xl:col-span-5 glass p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Phân bố điểm</h3>
                        <a href="/statistic" class="text-sm underline opacity-90 hover:opacity-100">Xem tất cả</a>
                    </div>
                    <div class="dist-bar">
                        <div class="dist-seg seg-high" style="--p: {{ sr_pcts.high }}"></div>
                        <div class="dist-seg seg-mid" style="--p: {{ sr_pcts.mid }}"></div>
                        <div class="dist-seg seg-low" style="--p: {{ sr_pcts.low }}"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-3 text-xs">
                        <div class="flex items-center gap-2"><span class="inline-block h-2 w-2 rounded-full"
                                style="background:#22c55e"></span><span>100–90</span><span
                                class="ml-auto font-semibold">{{ sr_counts.high }}</span></div>
                        <div class="flex items-center gap-2"><span class="inline-block h-2 w-2 rounded-full"
                                style="background:#f59e0b"></span><span>89–60</span><span
                                class="ml-auto font-semibold">{{ sr_counts.mid }}</span></div>
                        <div class="flex items-center gap-2"><span class="inline-block h-2 w-2 rounded-full"
                                style="background:#ef4444"></span><span>59–0</span><span
                                class="ml-auto font-semibold">{{ sr_counts.low }}</span></div>
                    </div>
                </div>

                <!-- HÀNG DƯỚI: tách thành GRID RIÊNG để 2 cột cao bằng nhau -->
                <div class="xl:col-span-12 grid xl:grid-cols-12 gap-6 items-stretch">
                    <!-- Trái: Bảng xếp hạng -->
                    <div class="xl:col-span-7 glass p-6 h-full">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">Xếp hạng thí sinh</h3>
                            <a href="/ranking?ct={{ contest.id }}"
                                class="text-sm underline opacity-90 hover:opacity-100">Xem đầy đủ</a>
                        </div>
                        <div class="overflow-x-auto overflow-y-auto max-h-[680px] rounded-xl ring-1 ring-white/10">
                            <table class="min-w-full text-sm text-white">
                                <thead class="sticky top-0 z-10"
                                    style="background: rgba(15,23,42,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.12);">
                                    <tr>
                                        <th class="px-3 py-2 text-left">#</th>
                                        <th class="px-3 py-2 text-left">Mã NV</th>
                                        <th class="px-3 py-2 text-left">Họ tên</th>
                                        <th class="px-3 py-2 text-left">Đơn vị</th>
                                        <th class="px-3 py-2 text-left">Tổng</th>
                                    </tr>
                                </thead>
                                <tbody class="[&_tr]:h-12">
                                    {% for r in rows %}
                                    <tr
                                        class="border-b border-white/10 {% if forloop.counter <= 3 %}bg-white/5{% endif %}">
                                        <td class="px-3 py-2">{{ forloop.counter }}</td>
                                        <td class="px-3 py-2">{{ r.maNV }}</td>
                                        <td class="px-3 py-2">{{ r.hoTen }}</td>
                                        <td class="px-3 py-2">{{ r.donVi }}</td>
                                        <td class="px-3 py-2">{{ r.total|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center opacity-70 py-4">Chưa có dữ liệu</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Phải: 4 ô + banner bám đáy -->
                    <div class="xl:col-span-5 h-full flex flex-col gap-6">
                        <!-- 4 ô nhỏ 2×2 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass p-5 flex items-center gap-4">
                                <img src="{% static 'icons/star.svg' %}" alt="" class="h-10 w-10 opacity-90">
                                <div>
                                    <div class="text-sm opacity-70">Điểm trung bình</div>
                                    <div class="text-2xl font-semibold leading-none">{{ avg_score|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="glass p-5 flex items-center gap-4">
                                <img src="{% static 'icons/attendant.png' %}" alt="" class="h-10 w-10 opacity-90">
                                <div>
                                    <div class="text-sm opacity-70">Số người tham dự</div>
                                    <div class="text-2xl font-semibold leading-none">{{ total_thi_sinh }}</div>
                                </div>
                            </div>
                            <div class="glass p-5 flex items-center gap-4">
                                <img src="{% static 'icons/pie.svg' %}" alt="" class="h-10 w-10 opacity-90">
                                <div>
                                    <div class="text-sm opacity-70">Mục D</div>
                                    <div class="text-2xl font-semibold leading-none">{% if metric_d %}{{ metric_d }}{%
                                        else %}—{% endif %}</div>
                                </div>
                            </div>
                            <div class="glass p-5 flex items-center gap-4">
                                <img src="{% static 'icons/wallet.svg' %}" alt="" class="h-10 w-10 opacity-90">
                                <div>
                                    <div class="text-sm opacity-70">Mục F</div>
                                    <div class="text-2xl font-semibold leading-none">{% if metric_f %}{{ metric_f }}{%
                                        else %}—{% endif %}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Banner: đẩy xuống đáy -->
                        <div class="glass p-6 flex flex-col md:flex-row items-center justify-between gap-6 mt-auto" style="backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
                            <div>
                                <h3 class="text-lg font-semibold mb-1">Setup cuộc thi cho tuần tới</h3>
                                <p class="opacity-80 text-sm">Thiết lập vòng thi, bài thi và thí sinh theo ý muốn.</p>
                                <a href="/organize/competitions"
                                    class="inline-block mt-3 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg">Đi
                                    tới trang Tổ chức</a>
                            </div>
                            <img src="{% static 'pics/cup.png' %}" alt="Competition"
                                class="w-50 md:w-60 rounded-xl shadow-lg">
                        </div>

                    </div>
                </div>
                <!-- Modal chọn cuộc thi -->
                <div id="contestModal"
                    class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
                    <div class="glass rounded-2xl p-6 w-[90%] max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Chọn cuộc thi</h3>

                        <div class="mb-3">
                            <input id="contestSearch" type="text" placeholder="Tìm theo tên hoặc mã..."
                                class="w-full rounded-xl bg-white/10 border border-white/15 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-400">
                        </div>

                        <ul id="contestList" class="space-y-2 max-h-[60vh] overflow-y-auto">
                            {% for item in active_contests %}
                            <li data-key="{{ item.tenCuocThi }} {{ item.ma }}">
                                <a href="?ct={{ item.id }}"
                                    class="block glass hover:bg-white/10 rounded-xl p-3 transition">
                                    <div class="font-semibold">{{ item.tenCuocThi }}</div>
                                    <div class="text-sm opacity-70">Mã: {{ item.ma }}</div>
                                </a>
                            </li>
                            {% endfor %}
                        </ul>

                        <button id="closeModal"
                            class="mt-4 w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Đóng</button>
                    </div>
                </div>
            </div> <!-- /Hàng trên + khu dưới -->
            {% endif %}
        </div>
    </div>
</div>

<script src="{% static 'core/management.js' %}?v={% now 'U' %}"></script>
{% endblock %}