{% extends "base.html" %}
{% load static %}
{% block title %}Chấm điểm{% endblock %}
<!doctype html>
<html lang="vi">

{% block head_extra %}
  <style>
    /* nới rộng vùng nội dung ra gần mép 2 bên */
      .container{
        max-width: 96vw;
        margin: 36px auto;
        padding: 0 12px;
      }
      
    h1 {
      font-size: 22px;
      margin: 0 0 24px;
    }

    :root {
      --control-h: 50px; 
      --font-base: 16px;    
    }

    @media (min-width: 1024px){
      :root {
        --control-h: 54px;
        --font-base: 17px;
      }
    }

    /* === Inputs trên nền kính === */
    .input {
      background: rgba(30, 41, 59, 0.28);
      color: #e5e7eb;
      border: 1px solid rgba(255, 255, 255, 0.489);
      border-radius: 12px;
      padding: 12px 14px;
      width: 100%;
      box-sizing: border-box;
      font-size: var(--font-base);
      height: var(--control-h);
      line-height: calc(var(--control-h) - 2px);

      -webkit-backdrop-filter: blur(8px) saturate(115%);
      backdrop-filter: blur(8px) saturate(115%);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .input:focus {
      outline: none;
      border-color: rgba(179, 203, 245, 0.55);   
      box-shadow:
        0 0 0 3px rgba(169, 211, 230, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    /* Select trong wrap vẫn giữ kích thước như cũ */
    .select-wrap > select {
      border: none;        
      color: inherit;
    }

    .field { width: 100%; }

    .select-wrap { 
      position: relative; 
      width: 100%;
      overflow: hidden;      
    }

    .select-wrap > select option { 
      white-space: normal; 
      color: #303131; 
    }

    @media (max-width: 768px){
      .select-wrap > select {
        max-width: 100vw;
      }
    }

    /* === Glass Button === */
    .btn {
      position: relative;
      background: #f4f1ecc6;
      color: #223382;
      border: 1px solid rgba(255, 255, 255, 0.22);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      max-width: 640px;
      margin: 12px auto 0;
      display: block;
      text-align: center;
      font-size: calc(var(--font-base) + 4px);
      transition: transform 0.12s ease, box-shadow 0.2s ease;
      height: var(--control-h);

      -webkit-backdrop-filter: blur(8px) saturate(130%);
      backdrop-filter: blur(8px) saturate(130%);
      box-shadow:
        0 12px 24px rgba(173, 188, 244, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    .btn::after {
      /* highlight gợn kính */
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(120% 80% at 30% -10%,
        rgba(255,255,255,0.45), rgba(255,255,255,0.0) 45%);
      pointer-events: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 16px 30px rgba(212, 192, 249, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn:active { transform: translateY(0); }

    .tpl-open-btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;             
      height: var(--control-h);      
      font-size: 0.85rem;
      text-align: center;
      margin: 0;            
      vertical-align: middle;   
      width: 156px;      
      flex-shrink: 0;    
    }


    /* === Glass Card (form + kết quả) === */
    .card {
      position: relative;
      /* lớp kính trong suốt */
      background: rgba(17, 24, 39, 0.28);            /* #111827 ~ slate-900 nhưng trong suốt */
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      box-sizing: border-box;
      width: 100%;
      max-width: 720px;                               /* hơi rộng hơn để đẹp trên desktop */
      margin-left: auto;
      margin-right: auto;

      /* kính mờ */
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);

      /* ánh sáng & chiều sâu */
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.06);

      /* viền trong sáng hơn như cạnh kính */
      outline: 1px solid rgba(255, 255, 255, 0.06);
    }

    /* vệt highlight nhẹ phía trên như kính */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(120% 60% at 10% -10%,
                  rgba(255, 255, 255, 0.20),
                  rgba(255, 255, 255, 0.06) 40%,
                  transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    /* fallback nếu trình duyệt không hỗ trợ backdrop-filter */
    @supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))) {
      .card {
        background: rgba(17, 24, 39, 0.75);
      }
    }


    .card label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 15px;
    }


    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937;
      text-align: left
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #334155
    }

    .muted {
      color: #94a3b8
    }

    /* === Glass Suggest (dropdown gợi ý) === */
    .suggest {
      background: rgba(2, 6, 23, 0.35);               /* #020617 ~ slate-950 trong suốt */
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 14px;
      margin-top: 6px;
      max-height: 260px;
      overflow: auto;

      -webkit-backdrop-filter: blur(12px) saturate(120%);
      backdrop-filter: blur(12px) saturate(120%);

      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .suggest a {
      display: block;
      color: #e5e7eb;
      text-decoration: none;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .suggest a:hover {
      background: rgba(255, 255, 255, 0.05);
    }


    /* score input nhỏ nhưng cùng chất liệu */
    .score-input {
      width: 92px;
      background: rgba(30, 41, 59, 0.28);
      color: #e5e7eb;
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 8px 10px;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);

    }

    /* toast trên nền kính (giữ màu green/red nhưng trong suốt) */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(22, 163, 74, 0.85);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      display: none;
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      backdrop-filter: blur(8px) saturate(120%);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .toast.error {
      background: rgba(239, 68, 68, 0.92);
      color: #fff;
    }


    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .invalid { border-color: #ef4444 !important; }

    /* === Responsive Fix cho mobile === */
    @media (max-width: 768px) {
      .container {
        max-width: 100vw;
        padding: 16px;
      }
      .card {
        width: 100%;
        max-width: none;
        margin: 12px auto 0;
        border-radius: 14px;
      }
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-overlay {
        padding: 16px;
      }
      .btn {
        font-size: calc(var(--font-base) + 2px);
      }
      .toast {
        left: 50%;
        right: auto;                 /* bỏ canh phải */
        top: calc(env(safe-area-inset-top, 0px) + 12px);
        bottom: auto;                /* bỏ canh đáy */
        transform: translateX(-50%);
        width: auto;
        max-width: min(520px, calc(100vw - 24px));
        text-align: center;
        z-index: 2000;               /* nằm trên các thẻ khác */
        border-radius: 14px;
        padding: 12px 16px;
        /* hiệu ứng rơi xuống nhẹ */
        animation: toastDrop 180ms ease-out;
      }
    }

    @keyframes toastDrop {
      from { opacity: 0; transform: translate(-50%, -8px); }
      to   { opacity: 1; transform: translate(-50%, 0); }
    }
    /* ==== Confirm Modal (glass) ==== */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal {
      width: min(520px, 92vw);
      background: rgba(17, 24, 39, 0.30);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      padding: 16px;
      color: #e5e7eb;

      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      box-shadow:
        0 12px 30px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.06);
    }

    .modal h4 {
      margin: 0 0 8px; font-size: 18px;
    }

    .modal p {
      margin: 0 0 14px; color: #cbd5e1;
    }

    .modal-actions {
      display: flex; gap: 10px; justify-content: flex-end;
    }

    /* ==== Wheel time picker (2 cột phút/giây) ==== */
    .wheel { 
      display: inline-flex; 
      gap: 12px; 
      position: relative; 
      user-select: none;                 /* NEW: không chọn chữ khi kéo */
    }

    .wheel-col {
      width: 72px; 
      height: 132px; 
      overflow-y: auto;
      scroll-snap-type: y mandatory; 
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch; /* NEW: inertial scroll trên iOS */
      touch-action: pan-y;               /* NEW: cho phép kéo theo trục dọc */
      overscroll-behavior: contain;      /* NEW: tránh giật trang ngoài */
      background: rgba(30,41,59,.28); 
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px; 
      -webkit-backdrop-filter: blur(8px); 
      backdrop-filter: blur(8px);
      cursor: grab;
    }
    .wheel-col.dragging { cursor: grabbing; } 

    .wheel-col::-webkit-scrollbar{ display: none; }

    .wheel-list { 
      margin: 0; 
      padding: 0; 
      list-style: none; 
    }

    .wheel-item {
      height: 44px; 
      line-height: 44px; 
      text-align: center; 
      font-size: 16px;
      scroll-snap-align: center; 
      color: #e5e7eb;
      cursor: pointer;                    /* NEW: click để chọn */
    }

    /* NEW: spacer ở đầu/cuối để 00 đứng giữa khi scrollTop = 0 */
    .wheel-item.wheel-spacer { 
      visibility: hidden; 
      pointer-events: none; 
    }

    .wheel-indicator {
      position:absolute; 
      left:0; right:0; 
      top:50%; 
      height:44px; 
      margin-top:-22px;
      border-radius: 10px; 
      background: rgba(255,255,255,.12);
      pointer-events:none;
    }

    .wheel-mask {
      position:absolute; 
      inset:0; 
      pointer-events:none;
      background: linear-gradient(
        to bottom, 
        rgba(17,24,39,.65), 
        transparen
        t 25%, 
        transparent 75%, 
        rgba(17,24,39,.65)
      );
      border-radius: 12px;
    }
    #tplModal input[type="number"]{
      background: rgba(30,41,59,.28);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      padding:8px 10px;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <!-- after -->
    <form id="searchForm" method="get" class="card" style="display:flex; flex-direction:column; gap:12px;">

      {% if competitions and competitions|length > 0 %}
        <div class="field">
          <label>Cuộc thi:</label>
          <div class="select-wrap">
            <select id="ctSelect" name="ct" class="input">
              <option value="">— Chọn cuộc thi —</option>
              {% for c in competitions %}
                <option value="{{ c.id }}" {% if selected_ct_id and c.id == selected_ct_id %}selected{% endif %}>
                  {{ c.ma }} — {{ c.tenCuocThi }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      {% else %}
        <div class="card">Chưa có <b>Cuộc thi</b> nào được bật. Vào <a href="/organize/">/organize/</a> để tạo/bật.</div>
      {% endif %}


      <!-- Ô nhập NV hoặc họ tên đặt sau Cuộc thi -->
      <div class="row" style="flex-direction:column; align-items:flex-start; gap:8px; position: relative;">
        <label>Nhập mã NV hoặc họ tên:</label>
        <div class="field">
          <input id="searchInput" class="input" type="text" name="q" value="{{ query }}" placeholder="VD: TS001 hoặc Nguyễn Văn A">
        </div>
        <div id="suggestBox" class="suggest" style="margin-top:6px; width:100%; display:none">
          {% if suggestions %}
            {% for s in suggestions %}
              <a href="/score/?ts={{ s.maNV }}&ct={{ selected_ct_id }}">{{ s.maNV }} — {{ s.hoTen }}</a>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      {% if competitions and competitions|length > 0 %}
      <div style="display:flex; flex-direction:column; gap:10px;">

        <!-- Vòng thi -->
        <div class="field">
          <label>Vòng thi:</label>
          <div class="select-wrap">
            <select id="vtSelect" name="vt" class="input" {% if not rounds or rounds|length == 0 %}disabled{% endif %}>
              <option value="">— Chọn vòng thi —</option>
              {% for v in rounds %}
                <option value="{{ v.id }}" {% if selected_vt_id and v.id == selected_vt_id %}selected{% endif %}>
                  {{ v.tenVongThi }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Bài thi -->
        <div class="field">
          <label>Bài thi:</label>
          <div class="select-wrap">
            <select id="btSelect" name="bt" class="input" {% if not tests or tests|length == 0 %}disabled{% endif %}>
              <option value="">— Chọn bài thi —</option>
              {% for b in tests %}
                <option value="{{ b.id }}" {% if selected_bt_id and b.id == selected_bt_id %}selected{% endif %}>
                  {{ b.ma }} — {{ b.tenBaiThi }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

      </div>
      {% endif %}


      <!-- Nút tìm -->
      <div style="display:flex; justify-content:center;">
        <button class="btn" type="submit">Tìm</button>
      </div>

    </form>

    <div id="searchHintCard" class="card" style="display:none">
      <div id="searchHintText" class="muted"></div>
    </div>

    {% if ct %}

    <!-- Phiếu điểm -->
    {% if selected_ts %}
    <div id="scoreCard" class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>Thí sinh:</b> {{ selected_ts.maNV }} — {{ selected_ts.hoTen }}</div>
          <div class="muted">Đơn vị: {{ selected_ts.donVi }} | Chi nhánh: {{ selected_ts.chiNhanh }}</div>
        </div>
        <div>Tổng tối đa: <span class="badge">{{ total_max }}</span></div>
      </div>

      {% if structure and total_max > 0 %}
      <table class="table">
        <thead>
          <tr>
            <th style="width:40%">Vòng thi – Bài thi</th>
            <th>Điểm (0..Max)</th>
            <th>Max</th>
          </tr>
        </thead>
        <tbody>
          {% for block in structure %}
          {% for b in block.bai_list %}
          <tr>
            <td>{{ b.ten }}</td>
            <td>
              {% if b.type == "TIME" %}
              <label class="inline-flex items-center" style="gap:8px">
                <input type="checkbox" name="done_{{ b.id }}" class="done-toggle" data-btid="{{ b.id }}"
                  {% if b.time_current is not None %}checked{% endif %}>
                <span>Hoàn thành</span>
              </label>
              <div class="time-wrap mt-2 {% if b.time_current is None %} hidden {% endif %}" data-btid="{{ b.id }}" data-max="{{ b.max }}" data-rules='{{ b.rules|safe }}' data-time="{{ b.time_current|default_if_none:'' }}"
     data-current="{{ b.current|default_if_none:'' }}">
                <div class="wheel" data-btid="{{ b.id }}">
                  <div class="wheel-col" data-type="min">
                    <ul class="wheel-list">
                      <li class="wheel-item wheel-spacer"></li>  {# spacer đầu #}
                      {% for i in range60 %}
                        <li class="wheel-item">{{ i|stringformat:"02d" }}</li>
                      {% endfor %}
                      <li class="wheel-item wheel-spacer"></li>  {# spacer cuối #}
                    </ul>
                    <div class="wheel-mask"></div>
                  </div>
                  <div class="wheel-col" data-type="sec">
                    <ul class="wheel-list">
                      <li class="wheel-item wheel-spacer"></li>  {# spacer đầu #}
                      {% for i in range60 %}
                        <li class="wheel-item">{{ i|stringformat:"02d" }}</li>
                      {% endfor %}
                      <li class="wheel-item wheel-spacer"></li>  {# spacer cuối #}
                    </ul>
                    <div class="wheel-mask"></div>
                  </div>
                  <div class="wheel-indicator"></div>
                </div>

                <!-- giữ hidden input để tương thích save payload -->
                <input type="hidden" class="time-input" name="time_{{ b.id }}" value="00:00">
                <span class="ml-2 muted">Điểm: <b class="time-score" id="preview_{{ b.id }}">{{ b.max }}</b> / {{ b.max }}</span>
              </div>

              {% elif b.type == "TEMPLATE" %}
              <div style="display:flex; align-items:center; gap: 8px;">
                <button type="button" class="btn tpl-open-btn"
                        data-btid="{{ b.id }}" data-bcode="{{ b.code|escapejs }}">
                  Chấm theo mẫu
                </button>
                <span id="preview-total-{{ b.id }}" class="ml-2 muted">
                  {% if b.current != None %}Tổng: {{ b.current|floatformat:0 }}{% else %}Chưa chấm{% endif %}
                </span>
                <input type="hidden" name="score_{{ b.id }}" id="score-input-{{ b.id }}" data-max="{{ b.max }}" value = "{% if b.current != None %}{{ b.current|floatformat:0 }}{% endif %}>
                <input type="hidden" name="tpl_time_{{ b.id }}" id="tpl-time-{{ b.id }}" value="">
              </div>
              {% else %}
              <input class="score-input" type="number" min="0" max="{{ b.max }}" step="1" name="score_{{ b.id }}"
                value="{% if b.current != None %}{{ b.current|floatformat:0 }}{% endif %}">
              {% endif %}

            </td>
            <td>{{ b.max }}</td>


          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveBtn" type="button" data-ct="{{ selected_ct_id }}"
          data-ts="{% if selected_ts %}{{ selected_ts.maNV }}{% endif %}">Lưu điểm</button>


      </div>
      {% else %}
      <!-- after -->
      <div class="muted">
        Cuộc thi hiện chưa có Vòng/Bài thi.
        {% if competitions and competitions|length > 1 %}
        Bạn có thể đổi sang cuộc khác ở phần “Cuộc thi” phía trên.
        {% endif %}
        <a href="/organize/" style="color:#93c5fd">Thêm Vòng/Bài</a>
      </div>

      {% endif %}
    </div>
    {% endif %}
    {% endif %}
  </div>

  <div id="toast" class="toast"></div>
  <!-- Modal chấm theo mẫu -->
  <div id="tplModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.58); -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px); z-index:999;">
    <div style="background:rgba(17,24,39,.42); color:#e5e7eb; width:min(900px,92vw); margin:5vh auto; padding:16px; border-radius:16px; border:1px solid rgba(255,255,255,.18); outline:1px solid rgba(255,255,255,.06); -webkit-backdrop-filter:blur(16px) saturate(120%); backdrop-filter:blur(16px) saturate(120%); box-shadow:0 16px 40px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06)">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <h3 id="tplTitle" style="margin:0">Chấm theo mẫu</h3>
        <button onclick="closeTplModal()">✕</button>
      </div>
      <div id="tplBody" style="max-height:60vh; overflow:auto; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(2,6,23,.18); -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px); box-shadow:inset 0 1px 0 rgba(255,255,255,.05); padding:8px"></div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px">

        <div> Tổng: <strong id="tplTotal">0</strong> / <span id="tplMax">0</span>
          {% if selected_ts %}
            <span class="muted" style="margin-left:10px">
              Thí sinh: <b>{{ selected_ts.maNV }}</b> — {{ selected_ts.hoTen }}
            </span>
          {% endif %}
        </div>
        <div>
          <!-- ẨN input: vẫn giữ id để JS hiện tại dùng, nhưng không hiển thị -->
          <input id="tplThiSinh"
                type="hidden"
                value="{% if selected_ts %}{{ selected_ts.maNV }}{% endif %}">
          <button id="tplSaveBtn" class="btn" style="font-size: 0.9rem;" onclick="saveTplScores()" {% if not selected_ts %}disabled title="Chọn thí sinh trước khi chấm theo mẫu"{% endif %}>
            Lưu
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <h4 id="confirmTitle">Xác nhận</h4>
      <p id="confirmMessage">Bạn có chắc chắn?</p>
      <div class="modal-actions">
        <button id="confirmCancel" class="btn" type="button">Hủy</button>
        <button id="confirmOk" class="btn" type="button">Đồng ý</button>
      </div>
    </div>
  </div>

  <script src="{% static 'core/score.js' %}?v={% now 'U' %}"></script>
{% endblock %}