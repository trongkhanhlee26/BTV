{% load static %}
<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <title>Chấm điểm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, Segoe UI, Roboto
    }

    /* nới rộng vùng nội dung ra gần mép 2 bên */
      .container{
        max-width: 96vw;
        margin: 16px auto;
        padding: 0 12px;
      }
      input,
      select,
      button {
        font-family: inherit;
      }


    /* form filter: mặc định cho phép xuống dòng (mobile), desktop thì giữ 1 hàng */
    .row--filters{ flex-wrap: wrap; }
    @media (min-width: 1024px){
      .row--filters{ flex-wrap: nowrap; }
    }


    h1 {
      font-size: 22px;
      margin: 0 0 12px
    }

    .input {
      background: #1e293b;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    .field { width: 100%; }

    .btn {
      background: #f59e0b;
      color: #111827;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;          /* full width button */
      max-width: 600px;     /* khớp max-width của .card */
      margin: 12px auto 0;  /* căn giữa */
      display: block;
      text-align: center;
      font-size: 16px;
      transition: all 0.2s ease-in-out;
    }

    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 14px;
      margin-top: 12px;
      box-sizing: border-box;
      width: 100%;
      max-width: 600px;     /* giới hạn chiều rộng desktop */
      margin-left: auto;
      margin-right: auto;
    }

    .card label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }


    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937;
      text-align: left
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #334155
    }

    .muted {
      color: #94a3b8
    }

    .suggest {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 8px;
      margin-top: 6px;
      max-height: 220px;
      overflow: auto
    }

    .suggest a {
      display: block;
      color: #e5e7eb;
      text-decoration: none;
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937
    }

    .suggest a:hover {
      background: #1f2937
    }

    .score-input {
      width: 80px;
      background: #1e293b;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 6px
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #16a34a;
      color: #081016;
      padding: 10px 14px;
      border-radius: 10px;
      display: none
    }

    .toast.error {
      background: #ef4444;
      color: white
    }

    /* === Responsive Fix cho mobile === */
    @media (max-width: 768px) {
      .container {
        max-width: 100vw;
        padding: 0 16px; /* tạo khoảng cách đều 2 bên */
      }
      .card {
        width: 100%;
        max-width: none; /* full chiều ngang trong khung container */
        margin: 0 auto;
      }
      .row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>

  

</head>

<body>
  <div class="container">
    <!-- after -->
    <h1>Chấm điểm (Cuộc thi)</h1>

    <form id="searchForm" method="get" class="card" style="display:flex; flex-direction:column; gap:12px;">

      {% if competitions and competitions|length > 0 %}
      <div style="display:flex; flex-direction:column; gap:10px;">

        <!-- Cuộc thi lên trước -->
        <div class="field">
          <label>Cuộc thi:</label>
          <select id="ctSelect" name="ct" class="input">
            {% for c in competitions %}
              <option value="{{ c.id }}" {% if selected_ct_id and c.id == selected_ct_id %}selected{% endif %}>
                {{ c.ma }} — {{ c.tenCuocThi }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
      {% endif %}

      <!-- Ô nhập NV hoặc họ tên đặt sau Cuộc thi -->
      <div class="row" style="flex-direction:column; align-items:flex-start; gap:8px; position: relative;">
        <label>Nhập mã NV hoặc họ tên:</label>
        <div class="field">
          <input id="searchInput" class="input" type="text" name="q" value="{{ query }}" placeholder="VD: TS001 hoặc Nguyễn Văn A">
        </div>
        <div id="suggestBox" class="suggest" style="margin-top:6px; width:100%; display:none">
          {% if suggestions %}
            {% for s in suggestions %}
              <a href="/score/?ts={{ s.maNV }}&ct={{ selected_ct_id }}">{{ s.maNV }} — {{ s.hoTen }}</a>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      {% if competitions and competitions|length > 0 %}
      <div style="display:flex; flex-direction:column; gap:10px;">

        <!-- Vòng thi -->
        <div class="field">
          <label>Vòng thi:</label>
          <select id="vtSelect" name="vt" class="input" {% if not rounds or rounds|length == 0 %}disabled{% endif %}>
            <option value="">— Tất cả vòng —</option>
            {% for v in rounds %}
              <option value="{{ v.id }}" {% if selected_vt_id and v.id == selected_vt_id %}selected{% endif %}>
                {{ v.tenVongThi }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Bài thi -->
        <div class="field">
          <label>Bài thi:</label>
          <select id="btSelect" name="bt" class="input" {% if not tests or tests|length == 0 %}disabled{% endif %}>
            <option value="">— Tất cả bài —</option>
            {% for b in tests %}
              <option value="{{ b.id }}" {% if selected_bt_id and b.id == selected_bt_id %}selected{% endif %}>
                {{ b.ma }} — {{ b.tenBaiThi }}
              </option>
            {% endfor %}
          </select>
        </div>

      </div>
      {% endif %}


      <!-- Nút tìm -->
      <div style="display:flex; justify-content:center;">
        <button class="btn" type="submit">Tìm</button>
      </div>

    </form>



    {% if not ct %}
    <div class="card">Chưa có <b>Cuộc thi</b> nào được bật. Vào <a href="/organize/">/organize/</a> để tạo/bật.</div>
    {% else %}

    <!-- Phiếu điểm -->
    {% if selected_ts %}
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>Thí sinh:</b> {{ selected_ts.maNV }} — {{ selected_ts.hoTen }}</div>
          <div class="muted">Đơn vị: {{ selected_ts.donVi }} | Chi nhánh: {{ selected_ts.chiNhanh }}</div>
        </div>
        <div>Tổng tối đa: <span class="badge">{{ total_max }}</span></div>
      </div>

      {% if structure and total_max > 0 %}
      <table class="table">
        <thead>
          <tr>
            <th style="width:40%">Vòng thi – Bài thi</th>
            <th>Điểm (0..Max)</th>
            <th>Max</th>
          </tr>
        </thead>
        <tbody>
          {% for block in structure %}
          {% for b in block.bai_list %}
          <tr>
            <td>{{ b.ten }} <span class="muted">({{ b.code }})</span></td>
            <td>
              {% if b.type == "TIME" %}
              <label class="inline-flex items-center" style="gap:8px">
                <input type="checkbox" name="done_{{ b.id }}" class="done-toggle" data-btid="{{ b.id }}">
                <span>Hoàn thành</span>
              </label>
              <div class="time-wrap mt-2 hidden" data-btid="{{ b.id }}" data-rules='{{ b.rules|safe }}'>
                <input class="score-input time-input" type="text" placeholder="mm:ss hoặc giây" name="time_{{ b.id }}"
                  disabled>
                <span class="ml-2 muted">Điểm: <b class="time-score" id="preview_{{ b.id }}">0</b> / {{ b.max }}</span>
              </div>

              {% elif b.type == "TEMPLATE" %}
              <button type="button" class="btn tpl-open-btn" data-btid="{{ b.id }}"
                data-bcode="{{ b.code|escapejs }}">Chấm theo mẫu</button>


              <span id="preview-total-{{ b.id }}" class="muted">Chưa chấm</span>
              <input type="hidden" name="score_{{ b.id }}" id="score-input-{{ b.id }}" value="">

              {% else %}
              <input class="score-input" type="number" min="0" max="{{ b.max }}" step="1" name="score_{{ b.id }}"
                value="{% if b.current != None %}{{ b.current|floatformat:0 }}{% endif %}">
              {% endif %}

            </td>
            <td>{{ b.max }}</td>


          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveBtn" type="button" data-ct="{{ selected_ct_id }}"
          data-ts="{% if selected_ts %}{{ selected_ts.maNV }}{% endif %}">Lưu điểm</button>


      </div>
      {% else %}
      <!-- after -->
      <div class="muted">
        Cuộc thi hiện chưa có Vòng/Bài thi.
        {% if competitions and competitions|length > 1 %}
        Bạn có thể đổi sang cuộc khác ở phần “Cuộc thi” phía trên.
        {% endif %}
        <a href="/organize/" style="color:#93c5fd">Thêm Vòng/Bài</a>
      </div>

      {% endif %}
    </div>
    {% endif %}
    {% endif %}
  </div>

  <div id="toast" class="toast"></div>
  <!-- Modal chấm theo mẫu -->
  <div id="tplModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:999;">
    <div
      style="background:#111827; color:#e5e7eb; width:min(900px,92vw); margin:5vh auto; padding:16px; border-radius:10px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <h3 id="tplTitle" style="margin:0">Chấm theo mẫu</h3>
        <button onclick="closeTplModal()">✕</button>
      </div>

      <div id="tplBody" style="max-height:60vh; overflow:auto; border:1px solid #1f2937; padding:8px"></div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px">
        <div>
          Tổng: <strong id="tplTotal">0</strong> / <span id="tplMax">0</span>
          {% if selected_ts %}
            <span class="muted" style="margin-left:10px">
              Thí sinh: <b>{{ selected_ts.maNV }}</b> — {{ selected_ts.hoTen }}
            </span>
          {% endif %}
        </div>
        <div>
          <!-- ẨN input: vẫn giữ id để JS hiện tại dùng, nhưng không hiển thị -->
          <input id="tplThiSinh"
                type="hidden"
                value="{% if selected_ts %}{{ selected_ts.maNV }}{% endif %}">
          <button id="tplSaveBtn" onclick="saveTplScores()" {% if not selected_ts %}disabled title="Chọn thí sinh trước khi chấm theo mẫu"{% endif %}>
            Lưu
          </button>
        </div>
      </div>

    </div>
  </div>

  <script src="{% static 'core/score.js' %}?v={% now 'U' %}"></script>


</body>

</html>